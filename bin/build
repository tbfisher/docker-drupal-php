#!/bin/bash

# exit on error, unset vars
set -eu
# exit early for errors in pipelines
set -o pipefail

usage() {
    cat << EOF
usage: $0 [options] major_version minor_version patch_version build

OPTIONS:
    -n        docker build with --no-cache.
    -d        Diff files using supplied utility e.g. diff.
    -v        Verbose output, prints every command to stdout.
    -h        Prints this help message.
EOF
}

# Options
cache=
diff=
while getopts ":nd:vh" opt; do
    case $opt in
        n)
            cache=--no-cache
            ;;
        d)
            diff=$OPTARG
            ;;
        v)
            set -x
            ;;
        h)
            usage
            exit
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            usage
            exit 1
            ;;
        :)
            echo "Option -$OPTARG requires an argument." >&2
            exit 1
            ;;
    esac
done

# Positional arguments
shift "$((OPTIND-1))"
if [ "$#" -ne 4 ]; then
    echo "Illegal number of parameters"
    usage
    exit 1
fi
version_major=$1
version_minor=$2
version_patch=$3
build=$4

v_full=$version_major.$version_minor.$version_patch
echo
echo Building "$v_full"
echo

## Dockerfile

write_version() {
    sed -i '' -E "s/^FROM php:([0-9\.]+)-fpm$/FROM php:${v_full}-fpm/" "$1"
}
write_version "$build/Dockerfile"

## Build

# pre-build config
curl -L "https://raw.githubusercontent.com/php/php-src/php-${v_full}/php.ini-development" > "$build/conf/php/php.ini-default"
if [[ $version_major == '5' && $version_minor -lt '6' ]]; then
  curl -L "https://raw.githubusercontent.com/docker-library/php/master/5.6/jessie/fpm/docker-php-entrypoint" > "$build/docker-php-entrypoint-default"
else
  curl -L "https://raw.githubusercontent.com/docker-library/php/master/$version_major.$version_minor/jessie/fpm/docker-php-entrypoint" > "$build/docker-php-entrypoint-default"
fi

# build image
docker build $cache -f "$build/Dockerfile" -t "drupal-php:${v_full}-$build" "./$build"

# # post-build config
docker run --rm "drupal-php:${v_full}-$build" /bin/cat /usr/local/etc/php-fpm.conf.bak > "$build/conf/php-fpm.conf.bak"
docker run --rm "drupal-php:${v_full}-$build" /bin/cat /usr/local/etc/php-fpm.conf.default > "$build/conf/php-fpm.conf.default"

set +e

# examine config
if [[ -n "$diff" ]]; then
    $diff "$build/conf/php/php.ini-default"           "$build/conf/php/php.ini"     &
    $diff "$build/conf/php/php.ini"                   "$build/conf/php/php-cli.ini" &
    $diff "$build/conf/php-fpm.conf.bak"              "$build/conf/php-fpm.conf"    &
    $diff "$build/conf/php-fpm.conf.default"          "$build/conf/php-fpm.conf"    &
    $diff "$build/docker-php-entrypoint-default"      "$build/docker-php-entrypoint"    &
fi
