#!/bin/bash

set -e

usage() {
    echo "Usage: $0 [-n] [-d diff] major_version minor_version patch_version" 1>&2
    exit 1
}

# Options
cache=""
while getopts ":d:n" opt; do
  case $opt in
    n)
      cache=--no-cache
      ;;
    d)
      diff=$OPTARG
      ;;
    *)
      usage
      ;;
  esac
done

# Positional arguments
version_major=${@:$OPTIND:1}
version_minor=${@:$OPTIND+1:1}
version_patch=${@:$OPTIND+2:1}
if [ -z "${version_major}" ] || [ -z "${version_minor}" ] || [ -z "${version_patch}" ]; then
    usage
fi

v_full=$version_major.$version_minor.$version_patch
echo
echo Building $v_full
echo

set -o xtrace

## Dockerfile

sed -i '' -E \
    "s/^FROM php:([0-9\.]+)-fpm$/FROM php:${v_full}-fpm/" \
    Dockerfile

## Build

# pre-build config
curl -L https://raw.githubusercontent.com/php/php-src/php-${v_full}/php.ini-development > \
    conf/php.ini-development-default
# write concise
echo [PHP] > conf/php-fpm.ini-development
diff -u conf/php.ini-development-default conf/php.ini-development | \
    grep -E "^\+" | grep -v -E "^\+\+\+" | \
    sed 's/^\+//g' >> conf/php-fpm.ini-development

docker build $cache -f Dockerfile -t drupal-php:${v_full}-fpm .

# post-build config
docker run --rm drupal-php:${v_full}-fpm /bin/cat /usr/local/etc/php-fpm.conf.bak > \
    conf/php-fpm.d/www.conf-default
docker run --rm drupal-php:${v_full}-fpm /bin/cat /usr/local/etc/php-fpm.conf.default > \
    conf/php-fpm.d/www.conf-default2

set +e

# examine config
if [[ -n "$diff" ]]; then
    $diff conf/php.ini-development-default conf/php.ini-development
    $diff conf/php-fpm.ini-development conf/php-cli.ini
    $diff conf/php-fpm.d/www.conf-default2 conf/php-fpm.d/www.conf-development
    $diff conf/php-fpm.d/www.conf-default conf/php-fpm.d/docker.conf
    $diff conf/php-fpm.d/www.conf-default conf/php-fpm.d/zz-docker.conf
fi
